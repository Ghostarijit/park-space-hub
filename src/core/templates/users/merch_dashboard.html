<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Tech | Product Insights Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background-color: #f8f9fa;
      }

      .top-controls {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
      }

      .chart-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .chart-card canvas {
        max-height: 350px;
      }

      .table-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-top: 30px;
        overflow-x: auto;
        max-height: 500px;
        overflow-y: auto;
      }

      .table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
        font-size: 15px;
        border-radius: 12px;
        overflow: hidden;
      }

      .table thead {
        background: linear-gradient(90deg, #007bff, #00bfff);
        color: #fff;
        position: sticky;
        top: 0;
        z-index: 2;
      }

      .table thead th {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 14px 16px;
        border: none;
      }

      .table tbody tr {
        transition: all 0.2s ease-in-out;
      }

      .table tbody tr:nth-child(even) {
        background-color: #f8f9fc;
      }

      .table tbody tr:hover {
        background-color: #eaf4ff;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .table td {
        padding: 12px 16px;
        vertical-align: middle;
      }

      .table td:first-child {
        font-weight: 600;
        color: #0d6efd;
      }

      .table td:nth-child(3) {
        color: #f39c12;
        font-weight: 600;
      }

      .table td:nth-child(4) {
        color: #e74c3c;
        font-weight: 600;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>

  <body>
    <div class="container py-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="fw-bold text-primary">
          <i class="bi bi-bar-chart-line"></i>Product Insights Dashboard
        </h1>
      </div>

      <!-- Upload & Download Buttons -->
      <div class="top-controls mb-4 justify-content-between flex-wrap">
        <form
          method="POST"
          enctype="multipart/form-data"
          class="d-flex align-items-center gap-2 flex-wrap"
        >
          {% csrf_token %}
          <div class="input-group" style="max-width: 420px">
            <input
              type="file"
              name="json_file"
              accept=".json"
              class="form-control"
              id="jsonFile"
              required
            />
            <button type="submit" class="btn btn-primary px-4">
              <i class="bi bi-upload"></i> Upload
            </button>

            <!-- Info Button -->
            <button
              type="button"
              class="btn btn-outline-info"
              id="infoBtn"
              title="Show instructions"
              aria-label="Show instructions"
            >
              <i class="bi bi-info-circle"></i>
            </button>
          </div>
        </form>

        <a href="{% url 'download_json' %}" class="btn btn-success px-4">
          <i class="bi bi-download"></i> Download Sample
        </a>
      </div>

      {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
      {% endif %}

      {% if data and chart_data.labels %}
      <!-- Charts -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="chart-card">
            <canvas id="gmvChart"></canvas>
          </div>
        </div>

        <div class="col-md-6">
          <div class="chart-card">
            <canvas id="ratingChart"></canvas>
          </div>
        </div>

        <div class="col-md-6 mt-4">
          <div class="chart-card text-center">
            <h5 class="mb-3">🧩 Return Rate Contribution by Product</h5>
            <canvas id="returnPieChart"></canvas>
          </div>
        </div>

        <div class="col-md-6 mt-4">
          <div class="chart-card text-center">
            <h5 class="mb-3">🛒 Orders Distribution by Product</h5>
            <canvas id="ordersDoughnutChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Product Table -->
      <h4 class="fw-bold mb-3 mt-4">📦 Product Performance Overview</h4>
      <div class="table-container">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Product</th>
              <th>GMV</th>
              <th>Avg Rating</th>
              <th>Return Rate (%)</th>
              <th>Orders</th>
              <th>Issues</th>
              <th>Suggestions</th>
            </tr>
          </thead>
          <tbody>
            {% for r in data %}
            <tr>
              <td>{{ r.product_name }}</td>
              <td>{{ r.gmv }}</td>
              <td
                style="color: {% if r.avg_rating < 3 %}#e67e22{% elif r.avg_rating >= 4 %}#2ecc71{% else %}#f1c40f{% endif %}; font-weight:600;"
              >
                {{ r.avg_rating }}
              </td>
              <td
                style="color: {% if r.return_rate > 3 %}#e74c3c{% else %}#27ae60{% endif %}; font-weight:600;"
              >
                {{ r.return_rate }}
              </td>
              <td>{{ r.total_orders }}</td>
              <td>{{ r.issues }}</td>
              <td>{{ r.suggestions }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% else %}
      <div class="alert alert-info mt-4">
        Upload a JSON file to see analysis.
      </div>
      {% endif %}
    </div>

    <script>
      {% if chart_data.labels %}
      const chartData = {{ chart_data|safe }};

      // GMV & Return Rate Chart
      new Chart(document.getElementById("gmvChart"), {
        type: "bar",
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: "GMV",
              data: chartData.gmv,
              backgroundColor: "rgba(54, 162, 235, 0.7)",
              yAxisID: "yGMV",
            },
            {
              label: "Return Rate (%)",
              data: chartData.returns,
              backgroundColor: "rgba(255, 99, 132, 0.7)",
              yAxisID: "yReturn",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: {
            yGMV: {
              type: "linear",
              position: "left",
              ticks: { beginAtZero: true },
            },
            yReturn: {
              type: "linear",
              position: "right",
              ticks: { beginAtZero: true },
              grid: { drawOnChartArea: false },
            },
          },
        },
      });

      // Avg Rating Chart
      new Chart(document.getElementById("ratingChart"), {
        type: "line",
        data: {
          labels: chartData.labels,
          datasets: [
            {
              label: "Avg Rating",
              data: chartData.rating,
              borderColor: "rgba(255, 206, 86, 0.9)",
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              pointRadius: 3,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            y: { min: 0, max: 5 },
          },
        },
      });

      // Return Rate Pie Chart
      (() => {
        const labels = chartData.labels;
        const returns = chartData.returns;
        new Chart(document.getElementById("returnPieChart"), {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Return Rate (%)",
                data: returns,
                backgroundColor: [
                  "rgba(255, 99, 132, 0.7)",
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(255, 206, 86, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                  "rgba(255, 159, 64, 0.7)",
                ],
                borderColor: "white",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (ctx) => `${ctx.label}: ${ctx.raw}% return rate`,
                },
              },
            },
          },
        });
      })();

      // Orders Doughnut Chart
      (() => {
        const labels = chartData.labels;
        const orders = chartData.total_orders || [];
        const total = orders.reduce((a, b) => a + b, 0);

        new Chart(document.getElementById("ordersDoughnutChart"), {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: orders,
                backgroundColor: [
                  "rgba(54, 162, 235, 0.7)",
                  "rgba(255, 206, 86, 0.7)",
                  "rgba(75, 192, 192, 0.7)",
                  "rgba(255, 99, 132, 0.7)",
                  "rgba(153, 102, 255, 0.7)",
                  "rgba(255, 159, 64, 0.7)",
                ],
                borderColor: "#fff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            cutout: "70%",
            plugins: {
              legend: { position: "bottom" },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const pct = ((ctx.raw / total) * 100).toFixed(1);
                    return `${ctx.label}: ${ctx.raw} orders (${pct}%)`;
                  },
                },
              },
              afterDraw: (chart) => {
                const { width, height, ctx } = chart;
                ctx.restore();
                const fontSize = (height / 160).toFixed(2);
                ctx.font = `${fontSize}em sans-serif`;
                ctx.textBaseline = "middle";
                const text = `Total ${total}`;
                const textX = Math.round(
                  (width - ctx.measureText(text).width) / 2
                );
                const textY = height / 1.9;
                ctx.fillStyle = "#333";
                ctx.fillText(text, textX, textY);
                ctx.save();
              },
            },
          },
        });
      })();
      {% endif %}

      // Info popup
      document.getElementById("infoBtn").addEventListener("click", () => {
        Swal.fire({
          title: "📘 How to Use",
          html: `
            <div style="text-align:left; font-size:15px; line-height:1.6;">
              <p>1️⃣ <strong>First, download</strong> the <b>Sample JSON</b> file to see the correct format.</p>
              <p>2️⃣ <strong>Edit or fill</strong> it with your eCommerce product data.</p>
              <p>3️⃣ <strong>Upload</strong> the modified JSON file here to view detailed insights and analytics.</p>
            </div>
          `,
          confirmButtonText: "Got it!",
          confirmButtonColor: "#3085d6",
          background: "#fff",
          color: "#333",
          showCloseButton: true,
          width: 500,
        });
      });
    </script>
  </body>
</html>
